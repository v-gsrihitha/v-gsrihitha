{
    "name": "GCPMonitorDCR",
    "apiVersion": "2022-06-01-preview",
    "type": "Microsoft.Insights/dataCollectionRules",
    "location": "{{location}}",
    "properties": {
        "dataCollectionEndpointId": "{{dataCollectionEndpointId}}",
        "streamDeclarations": {
            "Custom-GCPMonitor": {
                "columns": [
                    {
                        "name": "TenantId",
                        "type": "string"
                    },
                    {
                        "name": "SourceSystem",
                        "type": "string"
                    },
                    {
                        "name": "MG",
                        "type": "string"
                    },
                    {
                        "name": "ManagementGroupName",
                        "type": "string"
                    },
                    {
                        "name": "TimeGenerated",
                        "type": "datetime"
                    },
                    {
                        "name": "Computer",
                        "type": "string"
                    },
                    {
                        "name": "RawData",
                        "type": "string"
                    },
                    {
                        "name": "metric",
                        "type": "string"
                    },
                    {
                        "name": "resource",
                        "type": "string"
                    },
                    {
                        "name": "metricKind",
                        "type": "string"
                    },
                    {
                        "name": "valueType",
                        "type": "string"
                    },
                    {
                        "name": "interval_startTime",
                        "type": "timestamp"
                    },
                    {
                        "name": "interval_endTime",
                        "type": "timestamp"
                    },
                    {
                        "name": "value_int64Value",
                        "type": "dynamic"
                    },
                    {
                        "name": "Type",
                        "type": "string"
                    },
                    {
                        "name": "ResourceId",
                        "type": "string"
                    }
                ]
            }
        },
        "destinations": {
            "logAnalytics": [
                {
                    "workspaceResourceId": "{{workspaceResourceId}}",
                    "name": "clv2ws1"
                }
            ]
        },
        "dataFlows": [
            {
                "streams": [
                    "Custom-GCPMonitor"
                ],
                "destinations": [
                    "clv2ws1"
                ],
                "transformKql": "source | extend metricDynamic = parse_json(metric)  | extend resourceDynamic = parse_json(resource) | extend metric_type = tostring(metricdynamic['type']) | extend metric_labels_device_name = tostring(metricDynamic['labels']['device_name']) | extend metric_labels_instance_name = tostring(metricDynamic['labels']['instance_name']) | extend metric_labels_device_type = tostring(metricDynamic['labels']['device_type']) | extend metric_labels_storage_type = tostring(metricDynamic['labels']['storage_type']) | extend resource_type = tostring(resourcedynamic['type']) | extend resource_labels_zone = tostring(resourceDynamic['labels']['zone']) | extend resource_labels_instance_id = tostring(resourceDynamic['labels']['instance_id']) | extend resource_labels_project_id = tostring(resourceDynamic['labels']['project_id']) | extend TimeGenerated = timestamp| project TenantId, SourceSystem, MG, ManagementGroupName, TimeGenerated, Computer, RawData, metric_labels_device_name, metric_labels_storage_type, metric_labels_device_type, metric_labels_instance_name, metric_type, resource_type, resource_labels_zone, resource_labels_instance_id, resource_labels_project_id, metricKind, valueType, interval_startTime, interval_endTime, value_int64Value, Type, ResourceId",
                "outputStream": "Custom-GCPMonitorlogs_CL"
            }
        ]
    }
}